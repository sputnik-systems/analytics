
В ClickHouse оба алгоритма — `grace_hash` и `partial_merge` — предназначены для работы с большими таблицами, когда стандартный hash join не помещается в памяти, но реализованы по-разному и имеют разные сценарии применения.

---

##### `join_algorithm = 'grace_hash'`

- **Описание:** Алгоритм Grace Hash Join разбивает правую таблицу на N бакетов (корзин) по хешу ключа. Каждый бакет можно обрабатывать независимо. Если хеш-таблица для бакета превышает лимит памяти, количество бакетов увеличивается, и данные перераспределяются. Часть бакетов хранится на диске, и обрабатываются они по очереди.
    
- **Плюсы:** Позволяет выполнять JOIN больших таблиц с ограничением по памяти, гибко настраивается (например, через параметр `grace_hash_join_initial_buckets`).
    
- **Минусы:** Требует дополнительного времени на перераспределение и обработку бакетов, может быть медленнее сортировочных алгоритмов на некоторых данных.
    
- **Поддержка типов JOIN:** `INNER/LEFT/RIGHT/FULL ALL/ANY JOIN` [подробнее](https://clickhouse.com/docs/operations/settings/settings#join_algorithm).
    

---

##### `join_algorithm = 'partial_merge'`

- **Описание:** Это разновидность sort-merge join, где полностью сортируется только правая таблица. Правая таблица сортируется по ключу, создаётся min-max индекс для блоков. Затем части левой таблицы сортируются по ключу и поочерёдно соединяются с правой, используя индекс для пропуска ненужных блоков.
    
- **Плюсы:** Минимизирует использование памяти, так как не строит большую хеш-таблицу. Хорошо подходит для случаев, когда обе таблицы отсортированы по ключу.
    
- **Минусы:** Медленнее, чем hash join, из-за необходимости сортировки и последовательной обработки. Поддерживает не все типы JOIN (например, `RIGHT JOIN` и `FULL JOIN` только с `ALL` strictness).
    
- **Поддержка типов JOIN:** `RIGHT JOIN` и `FULL JOIN` поддерживаются только с `ALL` strictness (`SEMI`, `ANTI`, `ANY`, и `ASOF` не поддерживаются) [подробнее](https://clickhouse.com/docs/operations/settings/settings#join_algorithm).
    

---

##### Кратко о разнице

- **Grace Hash Join**: разбивает данные на бакеты по хешу, работает с диском, гибко по памяти, быстрее на некоторых данных.
    
- **Partial Merge Join**: сортирует данные, минимизирует память, но медленнее, особенно если данные не отсортированы.
    

**Выбор зависит от структуры данных, объёма и тр**